# Firebase Setup Guide for E-Village Banking

This guide will help you configure Firebase for push notifications in the E-Village Banking app.

## Prerequisites

- A Google account
- Flutter installed on your machine
- Access to the Firebase Console

## Step 1: Create a Firebase Project

1. Go to the [Firebase Console](https://console.firebase.google.com/)
2. Click "Add project" or select an existing project
3. Enter your project name (e.g., "e-village-banking")
4. Accept the terms and click "Continue"
5. (Optional) Enable Google Analytics for your project
6. Click "Create project"

## Step 2: Add Android App to Firebase

1. In your Firebase project, click the Android icon to add an Android app
2. Enter your Android package name: `com.example.e_village` (or your actual package name)
3. (Optional) Add an app nickname: "E-Village Banking Android"
4. (Optional) Add the SHA-1 fingerprint for authentication features
5. Click "Register app"
6. Download the `google-services.json` file
7. Move `google-services.json` to `android/app/` directory in your project

## Step 3: Add iOS App to Firebase (if targeting iOS)

1. In your Firebase project, click the iOS icon to add an iOS app
2. Enter your iOS bundle ID (found in `ios/Runner.xcodeproj/project.pbxproj`)
3. (Optional) Add an app nickname: "E-Village Banking iOS"
4. Click "Register app"
5. Download the `GoogleService-Info.plist` file
6. Add `GoogleService-Info.plist` to `ios/Runner/` directory using Xcode

## Step 4: Enable Cloud Messaging

1. In Firebase Console, go to **Build > Cloud Messaging**
2. If prompted, enable Cloud Messaging API
3. For Android: No additional configuration needed
4. For iOS: Upload your APNs authentication key or certificate

## Step 5: Install Firebase CLI and FlutterFire CLI

```bash
# Install Firebase CLI
npm install -g firebase-tools

# Login to Firebase
firebase login

# Install FlutterFire CLI
dart pub global activate flutterfire_cli
```

## Step 6: Configure Firebase in Flutter

Run the FlutterFire configuration command:

```bash
flutterfire configure
```

This command will:
- Ask you to select your Firebase project
- Generate a `firebase_options.dart` file in the `lib/` directory
- Configure Firebase for all selected platforms

## Step 7: Update Firebase Configuration in Code

The `main.dart` file already has Firebase initialization code. Verify it looks like this:

```dart
import 'package:firebase_core/firebase_core.dart';
import 'firebase_options.dart'; // Generated by FlutterFire CLI

void main() async {
  WidgetsFlutterBinding.ensureInitialized();

  // Initialize Supabase
  await SupabaseService.initialize();

  // Initialize Firebase (optional, add this if not present)
  await Firebase.initializeApp(
    options: DefaultFirebaseOptions.currentPlatform,
  );

  runApp(const MyApp());
}
```

## Step 8: Configure Android-specific Settings

1. Open `android/build.gradle` and ensure you have:

```gradle
buildscript {
    dependencies {
        classpath 'com.google.gms:google-services:4.4.0'
    }
}
```

2. Open `android/app/build.gradle` and add at the bottom:

```gradle
apply plugin: 'com.google.gms.google-services'
```

## Step 9: Configure iOS-specific Settings (if targeting iOS)

1. Open `ios/Runner/Info.plist` and add:

```xml
<key>FirebaseAppDelegateProxyEnabled</key>
<false/>
```

2. Open `ios/Podfile` and ensure platform is at least iOS 12:

```ruby
platform :ios, '12.0'
```

3. Run `pod install` in the `ios/` directory:

```bash
cd ios
pod install
cd ..
```

## Step 10: Test Push Notifications

### Test with Firebase Console

1. Go to Firebase Console > **Build > Cloud Messaging**
2. Click "Send your first message"
3. Enter a notification title and text
4. Click "Send test message"
5. Enter your device's FCM token (printed in debug console when app starts)
6. Click "Test"

### Get FCM Token for Testing

When you run the app in debug mode, the FCM token will be printed to the console:

```
FCM Token: <your-device-token>
```

You can also access it in the app through the NotificationProvider.

## Step 11: Store FCM Tokens in Supabase

To send targeted notifications, you should store FCM tokens in your Supabase database:

```sql
-- Add fcm_token column to user_profiles table
ALTER TABLE user_profiles ADD COLUMN fcm_token TEXT;

-- Create index for faster lookups
CREATE INDEX idx_user_profiles_fcm_token ON user_profiles(fcm_token);
```

Then update the token when it changes or refreshes.

## Troubleshooting

### Android Issues

- **Google Services plugin error**: Make sure `google-services.json` is in `android/app/`
- **Build fails**: Clean the project with `flutter clean` and rebuild
- **Notifications not received**: Check that the app has notification permissions

### iOS Issues

- **Build fails**: Run `pod install` in the `ios/` directory
- **Notifications not received**: Ensure APNs certificate is uploaded to Firebase
- **Xcode errors**: Open `ios/Runner.xcworkspace` in Xcode and verify the `GoogleService-Info.plist` is in the project

### General Issues

- **Firebase not initialized**: Ensure `firebase_options.dart` exists and is imported
- **Token is null**: Check that notification permissions are granted
- **Background notifications**: Configure background message handler in `notification_service.dart`

## Important Notes

1. **Security**: Never commit `google-services.json` or `GoogleService-Info.plist` to public repositories
2. **Token Refresh**: FCM tokens can change, make sure to update them in your database
3. **Platform Support**: Firebase Cloud Messaging works on Android and iOS. Web support requires additional configuration

## Optional: Server-side Notification Sending

To send notifications from your backend (e.g., Supabase Edge Functions):

```typescript
// Example Supabase Edge Function
import { createClient } from '@supabase/supabase-js'

Deno.serve(async (req) => {
  const { userIds, title, body, data } = await req.json()

  // Get FCM tokens from database
  const supabase = createClient(
    Deno.env.get('SUPABASE_URL'),
    Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')
  )

  const { data: users } = await supabase
    .from('user_profiles')
    .select('fcm_token')
    .in('id', userIds)

  const tokens = users.map(u => u.fcm_token).filter(Boolean)

  // Send via Firebase Admin SDK
  // (requires additional setup)

  return new Response(JSON.stringify({ sent: tokens.length }))
})
```

## Next Steps

After completing this setup:

1. Test notifications on a real device
2. Implement notification handling in your app
3. Set up notification categories and actions
4. Configure notification channels for Android
5. Test background and foreground notification scenarios

For more information, visit:
- [Firebase Cloud Messaging Documentation](https://firebase.google.com/docs/cloud-messaging)
- [FlutterFire Documentation](https://firebase.flutter.dev/)
